<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>caelus.run.case &#8212; Caelus Python Library (CPL) v5.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx13.css?v=bcebad1a" />
    <script src="../../../_static/documentation_options.js?v=35c0298d"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400,700'
          rel='stylesheet' type='text/css' />
 
    <style type="text/css">
      table.right { float: right; margin-left: 20px; }
      table.right td { border: 1px solid #ccc; }
      
    </style>
    <script type="text/javascript">
      // intelligent scrolling of the sidebar content
      $(window).scroll(function() {
        var sb = $('.sphinxsidebarwrapper');
        var win = $(window);
        var sbh = sb.height();
        var offset = $('.sphinxsidebar').position()['top'];
        var wintop = win.scrollTop();
        var winbot = wintop + win.innerHeight();
        var curtop = sb.position()['top'];
        var curbot = curtop + sbh;
        // does sidebar fit in window?
        if (sbh < win.innerHeight()) {
          // yes: easy case -- always keep at the top
          sb.css('top', $u.min([$u.max([0, wintop - offset - 10]),
                                $(document).height() - sbh - 200]));
        } else {
          // no: only scroll if top/bottom edge of sidebar is at
          // top/bottom edge of window
          if (curtop > wintop && curbot > winbot) {
            sb.css('top', $u.max([wintop - offset - 10, 0]));
          } else if (curtop < wintop && curbot < winbot) {
            sb.css('top', $u.min([winbot - sbh - offset - 20,
                                  $(document).height() - sbh - 200]));
          }
        }
      });
    </script>

  </head><body>
<div class="pageheader">
  <div>
    <a href="../../../index.html">
<!--      <img src="../../../_static/sphinxheader.png" alt="SPHINX" />-->
    </a>
  </div>
</div>

    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Home</a>&nbsp;|</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">caelus.run.case</a></li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for caelus.run.case</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># pylint: disable=invalid-name, protected-acess, bare-except</span>

<span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">CML Simulation</span>
<span class="sd">--------------</span>

<span class="sd">This module defines :class:`CMLSimulation` that provides a pythonic interface</span>
<span class="sd">to detail with a CML case directory. In addition to implementing methods to</span>
<span class="sd">perform actions, it also tracks the state of the analysis at any given time.</span>

<span class="sd">The module also provides an abstract interface :class:`CMLSimCollection` that</span>
<span class="sd">provides basic infrastructure to manage and manipulate a collection of</span>
<span class="sd">simulations as a group.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapping</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapping</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">abc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">fnmatch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">six</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..config</span><span class="w"> </span><span class="kn">import</span> <span class="n">cmlenv</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..io</span><span class="w"> </span><span class="kn">import</span> <span class="n">dictfile</span> <span class="k">as</span> <span class="n">cmlio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..io.caelusdict</span><span class="w"> </span><span class="kn">import</span> <span class="n">CaelusDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..post.logs</span><span class="w"> </span><span class="kn">import</span> <span class="n">SolverLog</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">osutils</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils.pyutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">import_script</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils.tojson</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONSerializer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">core</span> <span class="k">as</span> <span class="n">rcore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">tasks</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.cmd</span><span class="w"> </span><span class="kn">import</span> <span class="n">CaelusCmd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.udf</span><span class="w"> </span><span class="kn">import</span> <span class="n">SimUDFBase</span>

<span class="n">_lgr</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="CMLSimMeta">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimMeta">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CMLSimMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator to add dictfile accessors to CMLSimulation&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">cdict</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CMLSimMeta</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">cdict</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;_dictfile_attrs&quot;</span> <span class="ow">in</span> <span class="n">cdict</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">add_dictfile_attrs</span><span class="p">(</span><span class="n">cdict</span><span class="p">[</span><span class="s2">&quot;_dictfile_attrs&quot;</span><span class="p">])</span>

<div class="viewcode-block" id="CMLSimMeta.add_dictfile_attrs">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimMeta.add_dictfile_attrs">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_dictfile_attrs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attrmap</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create getters for dictionary file objects&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attrmap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">process_attr</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="CMLSimMeta.process_attr">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimMeta.process_attr">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process_attr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the attribute&quot;&quot;&quot;</span>
        <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;Return </span><span class="si">%s</span><span class="s2"> instance for this case&quot;</span> <span class="o">%</span> <span class="n">key</span>
        <span class="n">varname</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">key</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">getter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span>

            <span class="n">obj</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">read_if_present</span><span class="p">(</span><span class="n">casedir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dicts_accessed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">obj</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">property</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">doc</span><span class="o">=</span><span class="n">doc</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="CMLSimBase">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimBase">[docs]</a>
<span class="nd">@six</span><span class="o">.</span><span class="n">add_metaclass</span><span class="p">(</span><span class="n">CMLSimMeta</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CMLSimBase</span><span class="p">(</span><span class="n">JSONSerializer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class representing a simulation&quot;&quot;&quot;</span>

    <span class="c1">#: Attribute style access to OpenFOAM input dictionaries</span>
    <span class="n">_dictfile_attrs</span> <span class="o">=</span> <span class="n">cmlio</span><span class="o">.</span><span class="n">cml_std_files</span>

    <span class="c1">#: List of attributes to persist</span>
    <span class="n">_json_public_</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;run_config&#39;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case_name</span><span class="p">,</span> <span class="n">cml_env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basedir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            case_name (str): Unique identifier for the case</span>
<span class="sd">            env (CMLEnv): CML environment used to setup/run the case</span>
<span class="sd">            basedir (path): Location where the case is located/created</span>
<span class="sd">            parent (CMLSimCollection): Instance of the group manager</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#: CML environment used to run this case</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">cml_env</span> <span class="ow">or</span> <span class="n">cmlenv</span><span class="o">.</span><span class="n">cml_get_version</span><span class="p">()</span>
        <span class="c1">#: Unique name for this case</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">case_name</span>
        <span class="c1">#: Root directory containing the case</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span> <span class="o">=</span> <span class="n">osutils</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">basedir</span><span class="p">)</span> <span class="k">if</span> <span class="n">basedir</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="c1">#: Absolute path to the case directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">casedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c1">#: Instance of CMLSimCollection if part of a larger set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

        <span class="c1">#: Keep track of files accessed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dicts_accessed</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#: Dictionary containing run configuration (internal use only)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_config</span> <span class="o">=</span> <span class="n">CaelusDict</span><span class="p">()</span>

        <span class="c1">#: User-defined customization class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">udf</span> <span class="o">=</span> <span class="n">SimUDFBase</span><span class="p">()</span>

        <span class="c1">#: Dictionary tracking status (internal use only)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_flags</span> <span class="o">=</span> <span class="n">CaelusDict</span><span class="p">()</span>

<div class="viewcode-block" id="CMLSimBase.load">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimBase.load">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">casedir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">json_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Loads a previously setup case from persistence file&quot;&quot;&quot;</span>
        <span class="n">cdir</span> <span class="o">=</span> <span class="n">osutils</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">casedir</span><span class="p">)</span> <span class="k">if</span> <span class="n">casedir</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">jfile</span> <span class="o">=</span> <span class="n">json_file</span> <span class="ow">or</span> <span class="bp">cls</span><span class="o">.</span><span class="n">json_file</span><span class="p">()</span>
        <span class="n">jfile</span> <span class="o">=</span> <span class="n">osutils</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cdir</span><span class="p">,</span> <span class="n">jfile</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">jfile</span><span class="p">),</span> <span class="n">object_pairs_hook</span><span class="o">=</span><span class="n">CaelusDict</span><span class="p">)</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span> <span class="ow">or</span> <span class="n">cmlenv</span><span class="o">.</span><span class="n">cml_get_version</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">casedir</span> <span class="o">=</span> <span class="n">cdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">udf</span> <span class="o">=</span> <span class="n">SimUDFBase</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dicts_accessed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_public_</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="CMLSimBase.clone">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimBase.clone">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clone</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">template_dir</span><span class="p">,</span>
        <span class="n">copy_polymesh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">copy_zero</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">copy_scripts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">extra_patterns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">clean_if_present</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create the case directory from a given template</span>

<span class="sd">        Args:</span>
<span class="sd">            template_dir (path): Case directory to be cloned</span>
<span class="sd">            copy_polymesh (bool): Copy contents of constant/polyMesh to new case</span>
<span class="sd">            copy_zero (bool): Copy time=0 directory to new case</span>
<span class="sd">            copy_scripts (bool): Copy python and YAML files</span>
<span class="sd">            extra_patterns (list): List of shell wildcard patterns for copying</span>
<span class="sd">            clean_if_present (bool): Overwrite existing case</span>

<span class="sd">        Raises:</span>
<span class="sd">            IOError: If ``casedir`` exists and ``clean_if_present`` is False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">osutils</span><span class="o">.</span><span class="n">path_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">clean_if_present</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                <span class="s2">&quot;Refusing to overwrite existing case: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">casedir</span>
            <span class="p">)</span>
        <span class="n">rcore</span><span class="o">.</span><span class="n">clone_case</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">,</span>
            <span class="n">template_dir</span><span class="p">,</span>
            <span class="n">copy_polymesh</span><span class="p">,</span>
            <span class="n">copy_zero</span><span class="p">,</span>
            <span class="n">copy_scripts</span><span class="p">,</span>
            <span class="n">extra_patterns</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="CMLSimBase.clean">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimBase.clean">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clean</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">preserve_extra</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">preserve_polymesh</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">preserve_zero</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">preserve_times</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">preserve_processors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean an existing case directory.</span>

<span class="sd">        Args:</span>
<span class="sd">            preserve_extra (list): List of shell wildcard patterns to preserve</span>
<span class="sd">            preserve_polymesh (bool): If False, purges polyMesh directory</span>
<span class="sd">            preserve_zero (bool): If False, removes the 0 directory</span>
<span class="sd">            preserve_times (bool): If False, removes the time directories</span>
<span class="sd">            preserve_processors (bool): If False, removes processor directories</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rcore</span><span class="o">.</span><span class="n">clean_casedir</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">,</span>
            <span class="n">preserve_extra</span><span class="o">=</span><span class="n">preserve_extra</span><span class="p">,</span>
            <span class="n">preserve_zero</span><span class="o">=</span><span class="n">preserve_zero</span><span class="p">,</span>
            <span class="n">preserve_times</span><span class="o">=</span><span class="n">preserve_times</span><span class="p">,</span>
            <span class="n">preserve_processors</span><span class="o">=</span><span class="n">preserve_processors</span><span class="p">,</span>
            <span class="n">purge_mesh</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">preserve_polymesh</span><span class="p">),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="CMLSimBase.get_input_dict">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimBase.get_input_dict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_input_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dictname</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a CPL instance of the input file</span>

<span class="sd">        For standard input files, prefer to use the accessors directly instead</span>
<span class="sd">        of this method. For example, case.controlDict,</span>
<span class="sd">        case.turbulenceProperties, etc.</span>

<span class="sd">        Args:</span>
<span class="sd">            dictname (str): File name relative to case directory</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">osutils</span><span class="o">.</span><span class="n">set_work_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">):</span>
            <span class="n">cdict</span> <span class="o">=</span> <span class="n">cmlio</span><span class="o">.</span><span class="n">DictFile</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">dictname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dicts_accessed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cdict</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cdict</span></div>


<div class="viewcode-block" id="CMLSimBase.save_state">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimBase.save_state">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dump persistence file in JSON format&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">osutils</span><span class="o">.</span><span class="n">set_work_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_file</span><span class="p">(),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_json</span><span class="p">(),</span> <span class="n">fh</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_json_dumper_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>



<div class="viewcode-block" id="CMLSimulation">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimulation">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CMLSimulation</span><span class="p">(</span><span class="n">CMLSimBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pythonic interface to CML/OpenFOAM simulation</span>

<span class="sd">    This class defines the notion of an analysis. It provides methods to</span>
<span class="sd">    interact with an analysis directory from within python, and provides basic</span>
<span class="sd">    infrastructure to track the status of the simulation.</span>

<span class="sd">    After successful :meth:`setup`, the simulation moves through a series of</span>
<span class="sd">    stages, that can be queried via :meth:`status` method:</span>

<span class="sd">      =========== =================================================</span>
<span class="sd">      Status      Description</span>
<span class="sd">      =========== =================================================</span>
<span class="sd">      Setup       Case setup successfully</span>
<span class="sd">      Prepped     Pre-processing completed</span>
<span class="sd">      Submitted   Solver initialized</span>
<span class="sd">      Running     Solver is running</span>
<span class="sd">      Solved      Solve has completed</span>
<span class="sd">      DONE        Post-processing completed</span>
<span class="sd">      FAILED      Some action failed</span>
<span class="sd">      =========== =================================================</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_dictfile_attrs</span> <span class="o">=</span> <span class="n">cmlio</span><span class="o">.</span><span class="n">cml_std_files</span>

    <span class="n">_json_public_</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;name run_config run_flags &quot;</span> <span class="s2">&quot;_solver _logfile &quot;</span> <span class="s2">&quot;job_ids &quot;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="c1">#: Name of the task file for this case</span>
    <span class="n">task_file</span> <span class="o">=</span> <span class="s2">&quot;caelus_tasks.yaml&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case_name</span><span class="p">,</span> <span class="n">cml_env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basedir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            case_name (str): Unique identifier for the case</span>
<span class="sd">            env (CMLEnv): CML environment used to setup/run the case</span>
<span class="sd">            basedir (path): Location where the case is located/created</span>
<span class="sd">            parent (CMLSimCollection): Instance of the group manager</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">case_name</span><span class="p">,</span> <span class="n">cml_env</span><span class="p">,</span> <span class="n">basedir</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>

        <span class="c1">#: Dictionary tracking status (internal use only)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_flags</span> <span class="o">=</span> <span class="n">CaelusDict</span><span class="p">(</span>
            <span class="n">updated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">prepped</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">solve_submitted</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">solve_completed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">post_done</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">failed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1">#: Job IDs for SLURM/PBS jobs (internal use only)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_ids</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="CMLSimulation.update">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimulation.update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_mods</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the input files within a case directory</span>

<span class="sd">        Args:</span>
<span class="sd">            input_mods (CaelusDict): Dictionary with changes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">osutils</span><span class="o">.</span><span class="n">set_work_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">input_mods</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_input_files</span><span class="p">(</span><span class="n">input_mods</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_config</span><span class="p">,</span> <span class="s2">&quot;change_inputs&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_input_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_config</span><span class="o">.</span><span class="n">change_inputs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_modified_files</span><span class="p">()</span>
            <span class="c1"># Mark as updated, and possibly needs to be re-prepped</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_flags</span><span class="o">.</span><span class="n">updated</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_flags</span><span class="o">.</span><span class="n">prepped</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="CMLSimulation.prep_case">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimulation.prep_case">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">prep_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prep_tasks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute pre-processing tasks for this case</span>

<span class="sd">        If not tasks are provided, then uses the section ``prep`` from</span>
<span class="sd">        ``run_configuration`` that was passed during the setup phase.</span>

<span class="sd">        Args:</span>
<span class="sd">            prep_tasks (list): List of tasks for Tasks</span>
<span class="sd">            force (bool): Force prep again if already run</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">skip_prep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">udf</span><span class="o">.</span><span class="n">case_prep_prologue</span><span class="p">(</span><span class="n">case</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_prep</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_prep_case_default</span><span class="p">(</span><span class="n">prep_tasks</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">udf</span><span class="o">.</span><span class="n">case_prep_epilogue</span><span class="p">(</span><span class="n">case</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_prep_case_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prep_tasks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute pre-processing tasks for this case</span>

<span class="sd">        If not tasks are provided, then uses the section ``prep`` from</span>
<span class="sd">        ``run_configuration`` that was passed during the setup phase.</span>

<span class="sd">        Args:</span>
<span class="sd">            prep_tasks (list): List of tasks for Tasks</span>
<span class="sd">            force (bool): Force prep again if already run</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_flags</span><span class="o">.</span><span class="n">prepped</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">_lgr</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Detected previous prep, skipping&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_flags</span><span class="o">.</span><span class="n">updated</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="n">_lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing pre-processing tasks for case: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">tasklist</span> <span class="o">=</span> <span class="n">prep_tasks</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prep&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tasklist</span><span class="p">:</span>
                <span class="n">ctasks</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">Tasks</span><span class="p">()</span>
                <span class="n">ctasks</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="n">tasklist</span>
                <span class="n">ctasks</span><span class="p">(</span><span class="n">case_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
            <span class="c1"># Decompose the case if necessary</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decompose_case</span><span class="p">(</span><span class="n">ctasks</span><span class="o">.</span><span class="n">dep_job_id</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_flags</span><span class="o">.</span><span class="n">prepped</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">_lgr</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error encountered during prep for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_flags</span><span class="o">.</span><span class="n">failed</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="CMLSimulation.decompose_case">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimulation.decompose_case">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">decompose_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dep_job_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decompose case if necessary</span>

<span class="sd">        Args:</span>
<span class="sd">            dep_job_id (int): Job ID to wait for</span>
<span class="sd">            force (bool): Force rerun of decomposition tasks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_ranks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_ranks&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_ranks</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">num_proc_dirs</span> <span class="o">=</span> <span class="n">rcore</span><span class="o">.</span><span class="n">get_mpi_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">num_ranks</span> <span class="o">!=</span> <span class="n">num_proc_dirs</span><span class="p">)</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">osutils</span><span class="o">.</span><span class="n">set_work_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">):</span>
                <span class="n">decomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decomposeParDict</span>
                <span class="n">decomp</span><span class="o">.</span><span class="n">numberOfSubdomains</span> <span class="o">=</span> <span class="n">num_ranks</span>
                <span class="n">decomp</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>

                <span class="n">cml_cmd</span> <span class="o">=</span> <span class="n">CaelusCmd</span><span class="p">(</span>
                    <span class="s2">&quot;decomposePar&quot;</span><span class="p">,</span>
                    <span class="n">casedir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">,</span>
                    <span class="n">cml_env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
                    <span class="n">output_file</span><span class="o">=</span><span class="s2">&quot;decomposePar.log&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">cml_cmd</span><span class="o">.</span><span class="n">cml_exe_args</span> <span class="o">=</span> <span class="s2">&quot;-force&quot;</span>
                <span class="n">_lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Decomposing case: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">job_dep</span> <span class="o">=</span> <span class="p">[</span><span class="n">dep_job_id</span><span class="p">]</span> <span class="k">if</span> <span class="n">dep_job_id</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">cml_cmd</span><span class="p">(</span><span class="n">job_dependencies</span><span class="o">=</span><span class="n">job_dep</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cml_cmd</span><span class="o">.</span><span class="n">job_id</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">job_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cml_cmd</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">_lgr</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span>
                        <span class="s2">&quot;Error encountered during decomposePar for: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">run_flags</span><span class="o">.</span><span class="n">failed</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="CMLSimulation.solve">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimulation.solve">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute solve for this case</span>

<span class="sd">        Args:</span>
<span class="sd">            force (bool): Force resubmit even if previously submitted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rflags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_flags</span>
        <span class="k">if</span> <span class="n">rflags</span><span class="o">.</span><span class="n">solve_submitted</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">_lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Detected previous solve, skipping&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">rflags</span><span class="o">.</span><span class="n">prepped</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prep_case</span><span class="p">()</span>
        <span class="n">solve_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;solve&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">solve_opts</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot find solve settings for case: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">solve_opts</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,)):</span>
            <span class="k">for</span> <span class="n">sopt</span> <span class="ow">in</span> <span class="n">solve_opts</span><span class="p">:</span>
                <span class="n">solvstat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_solver</span><span class="p">(</span><span class="n">sopt</span><span class="p">)</span>
                <span class="n">status</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">solvstat</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">solve_opts</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_solver</span><span class="p">(</span><span class="n">solve_opts</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sopt</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="n">solve_opts</span><span class="p">,</span> <span class="n">solver_args</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_solver</span><span class="p">(</span><span class="n">sopt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_flags</span><span class="o">.</span><span class="n">solve_submitted</span> <span class="o">=</span> <span class="kc">True</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_run_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sopts</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper method to run the solver&quot;&quot;&quot;</span>
        <span class="n">dep_job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_ids</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">sopts</span><span class="p">[</span><span class="s2">&quot;solver&quot;</span><span class="p">]</span>
        <span class="n">log_file</span> <span class="o">=</span> <span class="n">sopts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;log_file&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">log_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logfile</span> <span class="o">=</span> <span class="n">log_file</span>
        <span class="n">solver_args</span> <span class="o">=</span> <span class="n">sopts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;solver_args&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">cml_cmd</span> <span class="o">=</span> <span class="n">CaelusCmd</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span>
            <span class="n">casedir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">,</span>
            <span class="n">cml_env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
            <span class="n">output_file</span><span class="o">=</span><span class="n">log_file</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">cml_cmd</span><span class="o">.</span><span class="n">cml_exe_args</span> <span class="o">=</span> <span class="n">solver_args</span>
        <span class="n">cml_cmd</span><span class="o">.</span><span class="n">num_mpi_ranks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_ranks&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">cml_cmd</span><span class="o">.</span><span class="n">mpi_extra_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mpi_extra_args&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;queue_settings&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_config</span><span class="p">:</span>
            <span class="n">cml_cmd</span><span class="o">.</span><span class="n">runner</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_config</span><span class="p">[</span><span class="s2">&quot;queue_settings&quot;</span><span class="p">])</span>
        <span class="n">_lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Submitting solver (</span><span class="si">%s</span><span class="s2">) for case: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">cml_cmd</span><span class="p">(</span><span class="n">job_dependencies</span><span class="o">=</span><span class="n">dep_job_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cml_cmd</span><span class="o">.</span><span class="n">job_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cml_cmd</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;Error encountered running </span><span class="si">%s</span><span class="s2"> for: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_flags</span><span class="o">.</span><span class="n">failed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">status</span>

<div class="viewcode-block" id="CMLSimulation.post_case">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimulation.post_case">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">post_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post_tasks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute post-processing tasks for this case&quot;&quot;&quot;</span>
        <span class="n">skip_post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">udf</span><span class="o">.</span><span class="n">case_post_prologue</span><span class="p">(</span><span class="n">case</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_post</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_post_case_default</span><span class="p">(</span><span class="n">post_tasks</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">udf</span><span class="o">.</span><span class="n">case_post_epilogue</span><span class="p">(</span><span class="n">case</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_post_case_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post_tasks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute post-processing tasks for this case&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_flags</span><span class="o">.</span><span class="n">post_done</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">_lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Detected previous post-processing, skipping&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_flags</span><span class="o">.</span><span class="n">solve_submitted</span><span class="p">:</span>
            <span class="n">_lgr</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: No previous solve detected, skipping post&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">clog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">case_log</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">clog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_lgr</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Solve has not started, skipping post&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">clog</span><span class="o">.</span><span class="n">solve_completed</span><span class="p">:</span>
            <span class="n">_lgr</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Solve was not completed, skipping post&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="n">_lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing post-processing tasks for case: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_flags</span><span class="o">.</span><span class="n">solve_completed</span> <span class="o">=</span> <span class="n">clog</span><span class="o">.</span><span class="n">solve_completed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reconstruct_case</span><span class="p">()</span>
        <span class="n">tasklist</span> <span class="o">=</span> <span class="n">post_tasks</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;post&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tasklist</span><span class="p">:</span>
                <span class="n">ctasks</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">Tasks</span><span class="p">()</span>
                <span class="n">ctasks</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="n">tasklist</span>
                <span class="n">ctasks</span><span class="p">(</span><span class="n">case_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_flags</span><span class="o">.</span><span class="n">post_done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">_lgr</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error occurred during post for: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_flags</span><span class="o">.</span><span class="n">failed</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="CMLSimulation.reconstruct_case">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimulation.reconstruct_case">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reconstruct_case</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reconstruct a parallel case&quot;&quot;&quot;</span>
        <span class="n">rconf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_config</span>
        <span class="n">num_ranks</span> <span class="o">=</span> <span class="n">rconf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;num_ranks&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dorecon</span> <span class="o">=</span> <span class="n">rconf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reconstruct&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dorecon</span> <span class="ow">and</span> <span class="p">(</span><span class="n">num_ranks</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">_lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reconstructing parallel run in case: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">cml_cmd</span> <span class="o">=</span> <span class="n">CaelusCmd</span><span class="p">(</span>
                <span class="s2">&quot;reconstructPar&quot;</span><span class="p">,</span>
                <span class="n">casedir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">,</span>
                <span class="n">cml_env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
                <span class="n">output_file</span><span class="o">=</span><span class="s2">&quot;reconstructPar.log&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">cml_cmd</span><span class="o">.</span><span class="n">cml_exe_args</span> <span class="o">=</span> <span class="s2">&quot;-latestTime&quot;</span>
            <span class="n">_lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reconstructing case: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">cml_cmd</span><span class="p">(</span><span class="n">job_dependencies</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">_lgr</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span><span class="s2">&quot;Error encountered during reconstruction&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_flags</span><span class="o">.</span><span class="n">failed</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="CMLSimulation.status">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimulation.status">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine status of the run</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Status of the run as a string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">run_flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_flags</span>
        <span class="n">status_list</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;failed post completed running submitted prep setup&quot;&quot;&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">status_names</span> <span class="o">=</span> <span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;FAILED DONE Solved Running Submitted Prepped Setup&quot;&quot;&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">status_flags</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">status_list</span><span class="p">:</span>
            <span class="n">status_flags</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">status_flags</span><span class="p">[</span><span class="s2">&quot;post&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_flags</span><span class="p">[</span><span class="s2">&quot;post_done&quot;</span><span class="p">]</span>
        <span class="n">status_flags</span><span class="p">[</span><span class="s2">&quot;prep&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_flags</span><span class="p">[</span><span class="s2">&quot;prepped&quot;</span><span class="p">]</span>
        <span class="n">status_flags</span><span class="p">[</span><span class="s2">&quot;setup&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_flags</span><span class="p">[</span><span class="s2">&quot;updated&quot;</span><span class="p">]</span>
        <span class="n">status_flags</span><span class="p">[</span><span class="s2">&quot;submitted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_flags</span><span class="p">[</span><span class="s2">&quot;solve_submitted&quot;</span><span class="p">]</span>
        <span class="n">status_flags</span><span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_flags</span><span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">status_flags</span><span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">]</span>
            <span class="ow">and</span> <span class="n">status_flags</span><span class="p">[</span><span class="s2">&quot;submitted&quot;</span><span class="p">]</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">status_flags</span><span class="p">[</span><span class="s2">&quot;completed&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">clog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">case_log</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">clog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">clog</span><span class="o">.</span><span class="n">solve_completed</span><span class="p">:</span>
                        <span class="n">run_flags</span><span class="p">[</span><span class="s2">&quot;solve_completed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clog</span><span class="o">.</span><span class="n">solve_completed</span>
                        <span class="n">status_flags</span><span class="p">[</span><span class="s2">&quot;completed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">clog</span><span class="o">.</span><span class="n">solve_completed</span>
                    <span class="k">elif</span> <span class="n">clog</span><span class="o">.</span><span class="n">failed</span><span class="p">:</span>
                        <span class="n">status_flags</span><span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">status_flags</span><span class="p">[</span><span class="s2">&quot;running&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">status_flags</span><span class="p">[</span><span class="s2">&quot;completed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">status_flags</span><span class="p">[</span><span class="s2">&quot;running&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">status_flags</span><span class="p">[</span><span class="s2">&quot;running&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">status_flags</span><span class="p">[</span><span class="s2">&quot;completed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">status_flags</span><span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">status_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">status_flags</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">status_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_update_input_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_mods</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Internal function to update input files&quot;&quot;&quot;</span>
        <span class="n">_lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating input files for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">mods</span> <span class="ow">in</span> <span class="n">input_mods</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">mods</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input_dict</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">mods</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_write_modified_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper function to write out modifications&quot;&quot;&quot;</span>
        <span class="n">_lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Saving modified files for </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dicts_accessed</span><span class="p">:</span>
            <span class="n">_lgr</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">write</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the solver used for this case&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_solver&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@solver</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">solver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_solver&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">logfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The log file for the solver&quot;&quot;&quot;</span>
        <span class="n">logname</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_logfile&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">logname</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_logfile&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logname</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.log&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot determine log file for case: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
            <span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_logfile&quot;</span><span class="p">,</span> <span class="n">logname</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logfile</span>

    <span class="nd">@logfile</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">logfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_logfile&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="CMLSimulation.case_log">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimulation.case_log">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">case_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force_reload</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a SolverLog instance for this case&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_logs&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_reload</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_logs&quot;</span><span class="p">)</span>

        <span class="n">logfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">osutils</span><span class="o">.</span><span class="n">path_exists</span><span class="p">(</span><span class="n">logfile</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">with</span> <span class="n">osutils</span><span class="o">.</span><span class="n">set_work_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">):</span>
            <span class="n">clog</span> <span class="o">=</span> <span class="n">SolverLog</span><span class="p">(</span>
                <span class="n">case_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">,</span>
                <span class="n">force_reload</span><span class="o">=</span><span class="n">force_reload</span><span class="p">,</span>
                <span class="n">logfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logfile</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_logs&quot;</span><span class="p">,</span> <span class="n">clog</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">clog</span></div>


<div class="viewcode-block" id="CMLSimulation.run_tasks">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimulation.run_tasks">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run tasks within case directory using the tasks file&quot;&quot;&quot;</span>
        <span class="n">tfile</span> <span class="o">=</span> <span class="n">task_file</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_file</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">osutils</span><span class="o">.</span><span class="n">path_exists</span><span class="p">(</span><span class="n">tfile</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">&quot;Cannot file task file for case: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">osutils</span><span class="o">.</span><span class="n">set_work_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">):</span>
            <span class="n">ctasks</span> <span class="o">=</span> <span class="n">tasks</span><span class="o">.</span><span class="n">Tasks</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">tfile</span><span class="p">)</span>
            <span class="n">ctasks</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="CMLSimCollection">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimCollection">[docs]</a>
<span class="nd">@six</span><span class="o">.</span><span class="n">add_metaclass</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CMLSimCollection</span><span class="p">(</span><span class="n">JSONSerializer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interface representing a collection of cases</span>

<span class="sd">    Implementations must implement :meth:`setup` that provides a concrete</span>
<span class="sd">    implementation of how the case is setup (either from a template or</span>
<span class="sd">    otherwise).</span>

<span class="sd">    Provides :meth:`prep`, :meth:`solve`, :meth:`post`, and :meth:`status` to</span>
<span class="sd">    interact with the collection as a whole. Prep, solve, and post can accept a</span>
<span class="sd">    list of shell-style wildcard patterns that will restrict the actions to</span>
<span class="sd">    matching cases only.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">basedir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            name (str): Unique name for this parametric run</span>
<span class="sd">            env (CMLEnv): CML excution environment</span>
<span class="sd">            basedir (path): Path where analysis directory is created</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#: Unique name for this parametric collection of cases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">bdir</span> <span class="o">=</span> <span class="n">basedir</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="c1">#: Location where parametric run setup is located</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span> <span class="o">=</span> <span class="n">osutils</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">bdir</span><span class="p">)</span>
        <span class="c1">#: Location of the parametric run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">casedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">osutils</span><span class="o">.</span><span class="n">path_exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">):</span>
            <span class="n">_lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Parametric run directory exists. Aborting&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot overwrite existing directory: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">casedir</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nested_file_guard</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basedir</span><span class="p">)</span>

        <span class="c1">#: CML execution environment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span> <span class="ow">or</span> <span class="n">cmlenv</span><span class="o">.</span><span class="n">cml_get_version</span><span class="p">()</span>

        <span class="c1">#: List of CMLSimulation instances</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#: Names of cases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">case_names</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1">#: UDF function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">udf</span> <span class="o">=</span> <span class="n">SimUDFBase</span><span class="p">()</span>

<div class="viewcode-block" id="CMLSimCollection.simulation_class">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimCollection.simulation_class">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">simulation_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Concrete instance of a Simulation</span>

<span class="sd">        Default is :class:`CMLSimulation`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">CMLSimulation</span></div>


<div class="viewcode-block" id="CMLSimCollection.udf_instance">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimCollection.udf_instance">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">udf_instance</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">custom_script</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">udf_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a UDF instance&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">custom_script</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SimUDFBase</span><span class="p">()</span>

        <span class="n">udfpar</span> <span class="o">=</span> <span class="n">udf_params</span> <span class="ow">or</span> <span class="n">CaelusDict</span><span class="p">()</span>
        <span class="n">udf_module</span> <span class="o">=</span> <span class="n">import_script</span><span class="p">(</span><span class="n">osutils</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">custom_script</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">udf_module</span><span class="p">,</span> <span class="s2">&quot;get_udf_instance&quot;</span><span class="p">)(</span><span class="n">udfpar</span><span class="p">)</span></div>


<div class="viewcode-block" id="CMLSimCollection.load">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimCollection.load">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">casedir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">json_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reload a persisted analysis group</span>

<span class="sd">        Args:</span>
<span class="sd">            env (CMLEnv): Environment for the analysis</span>
<span class="sd">            casedir (path): Path to the case directory</span>
<span class="sd">            json_file (filename): Persistence information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cdir</span> <span class="o">=</span> <span class="n">osutils</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">casedir</span><span class="p">)</span> <span class="k">if</span> <span class="n">casedir</span> <span class="k">else</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">jfile</span> <span class="o">=</span> <span class="n">json_file</span> <span class="ow">or</span> <span class="bp">cls</span><span class="o">.</span><span class="n">json_file</span><span class="p">()</span>
        <span class="n">jfile</span> <span class="o">=</span> <span class="n">osutils</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cdir</span><span class="p">,</span> <span class="n">jfile</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">jfile</span><span class="p">),</span> <span class="n">object_pairs_hook</span><span class="o">=</span><span class="n">CaelusDict</span><span class="p">)</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span> <span class="ow">or</span> <span class="n">cmlenv</span><span class="o">.</span><span class="n">cml_get_version</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">casedir</span> <span class="o">=</span> <span class="n">cdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_json_public_</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">udf</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">udf_instance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">udf_script</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">udf_params</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cases</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simulation_class</span><span class="p">()</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                <span class="n">env</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
                <span class="n">casedir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">,</span> <span class="n">cname</span><span class="p">),</span>
                <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">cname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">case_names</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cases</span><span class="p">:</span>
            <span class="k">case</span><span class="o">.</span><span class="n">udf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">udf</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">udf</span><span class="o">.</span><span class="n">sim_init_udf</span><span class="p">(</span><span class="n">simcoll</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_reload</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="CMLSimCollection.setup">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimCollection.setup">[docs]</a>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Logic to set up the analysis&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="CMLSimCollection.prep">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimCollection.prep">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">prep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run prep actions on the cases</span>

<span class="sd">        Args:</span>
<span class="sd">            cnames (list): Shell-style wildcard patterns</span>
<span class="sd">            force (bool): Force rerun</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_cases</span><span class="p">(</span><span class="n">cnames</span><span class="p">)</span> <span class="k">if</span> <span class="n">cnames</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">cases</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cases</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">prep_case</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">save_state</span><span class="p">()</span></div>


<div class="viewcode-block" id="CMLSimCollection.solve">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimCollection.solve">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run solve actions on the cases</span>

<span class="sd">        Args:</span>
<span class="sd">            cnames (list): Shell-style wildcard patterns</span>
<span class="sd">            force (bool): Force rerun</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_cases</span><span class="p">(</span><span class="n">cnames</span><span class="p">)</span> <span class="k">if</span> <span class="n">cnames</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">cases</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cases</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">save_state</span><span class="p">()</span></div>


<div class="viewcode-block" id="CMLSimCollection.post">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimCollection.post">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cnames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run post-processing tasks on the cases</span>

<span class="sd">        Args:</span>
<span class="sd">            cnames (list): Shell-style wildcard patterns</span>
<span class="sd">            force (bool): Force rerun</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_cases</span><span class="p">(</span><span class="n">cnames</span><span class="p">)</span> <span class="k">if</span> <span class="n">cnames</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">cases</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cases</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">post_case</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">save_state</span><span class="p">()</span></div>


<div class="viewcode-block" id="CMLSimCollection.status">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimCollection.status">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the status of the runs</span>

<span class="sd">        Yields:</span>
<span class="sd">            tuple: (name, status) for each case</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cases</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">status</span><span class="p">())</span></div>


<div class="viewcode-block" id="CMLSimCollection.save_state">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimCollection.save_state">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dump persistence file in JSON format&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">osutils</span><span class="o">.</span><span class="n">set_work_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">casedir</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">udf</span><span class="o">.</span><span class="n">sim_epilogue</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_file</span><span class="p">(),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_json</span><span class="p">(),</span> <span class="n">fh</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_json_dumper_</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cases</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">save_state</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="CMLSimCollection.filter_cases">
<a class="viewcode-back" href="../../../dev/caelus.run.html#caelus.run.case.CMLSimCollection.filter_cases">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">filter_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patterns</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter the cases based on a list of patterns</span>

<span class="sd">        The patterns are shell-style wildcard strings to match case directory</span>
<span class="sd">        names.</span>

<span class="sd">        Args:</span>
<span class="sd">            patterns (list): A list of one or more patterns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">casemap</span> <span class="o">=</span> <span class="n">CaelusDict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">case_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cases</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">pat</span> <span class="ow">in</span> <span class="n">patterns</span><span class="p">:</span>
            <span class="n">cnames</span> <span class="o">=</span> <span class="n">casemap</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">cnames</span><span class="p">,</span> <span class="n">pat</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">casemap</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">c</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_nested_file_guard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">basedir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check for nested simulation collections&quot;&quot;&quot;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">json_file</span><span class="p">()</span>
        <span class="n">wdir</span> <span class="o">=</span> <span class="n">basedir</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">wdir</span><span class="p">)</span>
        <span class="n">json_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="n">parent</span> <span class="o">!=</span> <span class="n">wdir</span><span class="p">:</span>
            <span class="n">jfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wdir</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">jfile</span><span class="p">):</span>
                <span class="n">json_file</span> <span class="o">=</span> <span class="n">jfile</span>
                <span class="k">break</span>
            <span class="n">wdir</span> <span class="o">=</span> <span class="n">parent</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">wdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">json_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_lgr</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Detected nested analysis directories. Aborting setup&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span>
                <span class="s2">&quot;Refusing to create nested analysis directories&quot;</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">udf_script</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the UDF script&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">udf_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the parameters for UDF script&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%d</span><span class="s2"> cases)&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cases</span><span class="p">),</span>
        <span class="p">)</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">Home</a>&nbsp;|</li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">caelus.run.case</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2017, Applied CCM.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    </div>
  </body>
</html>